<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>UB Rate My TA - Computer Science & Engineering</title>
    <style>
        :root {
            --ub-blue: #005bbb;
            --ub-white: #ffffff;
            --letchworth-autumn: #e56a54;
            --solar-strand: #ffc72c;
            --greiner-green: #ebec00;
            --lake-lasalle: #00a69c;
            --capen-brick: #990000;
            --bronze-buffalo: #ad841f;
            --olmsted-green: #6da04b;
            --niagara-whirlpool: #006570;
            --victor-e-blue: #2f9fd0;
            --harriman-blue: #002f56;
            --baird-point: #e4e4e4;
            --putnam-gray: #666666;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7fafc;
            --border-light: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .navbar {
            background: var(--ub-blue);
            color: var(--ub-white);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .title {
            font-weight: 700;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .title::before {
            content: "üêÇ";
            font-size: 1.5rem;
        }

        .btn {
            background: var(--ub-white);
            color: var(--ub-blue);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            background: var(--baird-point);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--ub-blue);
            color: var(--ub-white);
        }

        .btn-primary:hover {
            background: var(--harriman-blue);
        }

        .btn-disabled {
            background: var(--baird-point);
            color: var(--putnam-gray);
            cursor: not-allowed;
        }

        .btn-disabled:hover {
            transform: none;
            background: var(--baird-point);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1rem 3rem;
        }

        .hero {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, var(--ub-blue) 0%, var(--harriman-blue) 100%);
            color: var(--ub-white);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
        }

        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .hero p {
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
            opacity: 0.9;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            background: var(--ub-white);
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        .input, .select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            background: var(--ub-white);
            font-size: 0.95rem;
            flex: 1;
            min-width: 200px;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: var(--ub-blue);
            box-shadow: 0 0 0 3px rgba(0, 91, 187, 0.1);
        }

        .ta-list {
            display: grid;
            gap: 1rem;
        }

        .ta-card {
            background: var(--ub-white);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        .ta-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: var(--ub-blue);
        }

        .ta-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            color: var(--harriman-blue);
        }

        .ta-courses {
            font-size: 0.9rem;
            color: var(--putnam-gray);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .course-tag {
            background: var(--lake-lasalle);
            color: var(--ub-white);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
        }

        .ta-rating {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .rating-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--putnam-gray);
            letter-spacing: .05em;
            margin-bottom: 0.25rem;
        }

        .rating-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--capen-brick);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stars {
            color: var(--solar-strand);
            font-size: 1.25rem;
            margin-left: 0.5rem;
        }

        .empty {
            color: var(--putnam-gray);
            font-size: 1rem;
            text-align: center;
            padding: 2rem;
            background: var(--ub-white);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        .footer {
            background: var(--harriman-blue);
            color: var(--ub-white);
            text-align: center;
            padding: 1.5rem;
            margin-top: 3rem;
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--ub-white);
            text-decoration: underline;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--ub-white);
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--harriman-blue);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--putnam-gray);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--ub-blue);
            box-shadow: 0 0 0 3px rgba(0, 91, 187, 0.1);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Email Verification Styles */
        .verification-info {
            background: var(--baird-point);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--lake-lasalle);
        }

        .verification-code {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .code-input {
            width: 3rem;
            height: 3.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid var(--border-light);
            border-radius: 0.5rem;
        }

        .code-input:focus {
            border-color: var(--ub-blue);
            outline: none;
        }

        .resend-link {
            color: var(--ub-blue);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .timer {
            color: var(--putnam-gray);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* TA Detail Page */
        .ta-detail {
            background: var(--ub-white);
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .ta-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .ta-info h2 {
            font-size: 1.75rem;
            color: var(--harriman-blue);
            margin-bottom: 0.5rem;
        }

        .ai-summary {
            background: var(--baird-point);
            padding: 1.25rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--ub-blue);
        }

        .ai-summary h3 {
            color: var(--harriman-blue);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-summary h3::before {
            content: "ü§ñ";
        }

        .reviews-section h3 {
            margin-bottom: 1rem;
            color: var(--harriman-blue);
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 0.5rem;
        }

        .review-card {
            background: var(--bg-light);
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--lake-lasalle);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .review-rating {
            color: var(--solar-strand);
            font-weight: 600;
        }

        .review-date {
            color: var(--putnam-gray);
            font-size: 0.85rem;
        }

        .review-comment {
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .review-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .rating-category {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .rating-category-name {
            font-size: 0.9rem;
            color: var(--putnam-gray);
        }

        .rating-category-value {
            font-weight: 600;
            color: var(--harriman-blue);
        }

        .review-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .review-tag {
            background: var(--victor-e-blue);
            color: var(--ub-white);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
        }

        .review-course {
            display: inline-block;
            background: var(--olmsted-green);
            color: var(--ub-white);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        /* Rating breakdown */
        .rating-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .breakdown-category {
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .breakdown-category h4 {
            color: var(--harriman-blue);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--capen-brick);
        }

        /* Star rating input */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 1.5rem;
            color: var(--baird-point);
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: var(--solar-strand);
        }

        .tag-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag-option {
            background: var(--baird-point);
            color: var(--putnam-gray);
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-option.selected {
            background: var(--victor-e-blue);
            color: var(--ub-white);
        }

        @media (max-width: 768px) {
            .ta-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .ta-rating {
                text-align: left;
                align-items: flex-start;
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
            }

            .hero h1 {
                font-size: 2rem;
            }

            .filters {
                flex-direction: column;
            }

            .input, .select {
                min-width: 100%;
            }

            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .ta-header {
                flex-direction: column;
                gap: 1rem;
            }

            .review-details {
                grid-template-columns: 1fr;
            }

            .rating-breakdown {
                grid-template-columns: 1fr;
            }

            .verification-code {
                justify-content: center;
            }
        }

        /* Rating visualization */
        .rating-bar {
            width: 120px;
            height: 6px;
            background: var(--baird-point);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.25rem;
        }

        .rating-fill {
            height: 100%;
            background: var(--solar-strand);
        }

        /* User info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--ub-blue);
            color: var(--ub-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Verification Status */
        .verification-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .verified-badge {
            background: var(--olmsted-green);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .verified-badge::before {
            content: "‚úì";
        }

        /* Anonymous user styling */
        .anonymous-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--putnam-gray);
            font-size: 0.9rem;
        }

        .anonymous-user::before {
            content: "üôÇ";
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="title">UB Rate My TA</div>
    <button id="authButton" class="btn">Sign in with UB Email</button>
</nav>

<main class="container">
    <section class="hero">
        <h1>Computer Science & Engineering TAs</h1>
        <p>Find and rate teaching assistants to help improve the learning experience for everyone</p>
    </section>

    <div class="action-bar">
        <div class="filters">
            <input id="searchInput" class="input" placeholder="Search TA or course..." />
            <select id="courseSelect" class="select">
                <option value="all">All courses</option>
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>
        <button id="addTAButton" class="btn btn-primary">+ Add New TA</button>
    </div>

    <div id="taList" class="ta-list"></div>
    <p id="emptyState" class="empty" style="display:none;">
        No TAs match your search criteria. Try adjusting your filters.
    </p>
</main>

<!-- Modal for adding a new TA -->
<div id="addTAModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add New Teaching Assistant</h2>
            <button class="close-btn">&times;</button>
        </div>
        <form id="addTAForm">
            <div class="form-group">
                <label class="form-label" for="taName">TA Name</label>
                <input type="text" id="taName" class="form-input" placeholder="Enter TA's full name" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="taCourses">Courses (comma separated)</label>
                <input type="text" id="taCourses" class="form-input" placeholder="CSE 115, CSE 250" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" id="cancelAddTA">Cancel</button>
                <button type="submit" class="btn btn-primary">Add TA</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for authentication -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">UB Email Authentication</h2>
            <button class="close-btn">&times;</button>
        </div>

        <!-- Step 1: Email Input -->
        <div id="emailStep">
            <div class="verification-info">
                <p>To ensure only UB students can submit reviews, we'll send a verification code to your UB email address.</p>
            </div>
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label" for="emailInput">UB Email Address</label>
                    <input type="email" id="emailInput" class="form-input" placeholder="yourname@buffalo.edu" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" id="cancelAuth">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Verification Code</button>
                </div>
            </form>
        </div>

        <!-- Step 2: Code Verification -->
        <div id="codeStep" style="display: none;">
            <div class="verification-info">
                <p>We've sent a 6-digit verification code to <strong id="emailDisplay"></strong>.</p>
                <p>Please check your inbox and enter the code below.</p>
                <div class="timer" id="timer">Code expires in: 10:00</div>
                <a class="resend-link" id="resendCode">Didn't receive the code? Resend</a>
            </div>
            <form id="codeForm">
                <div class="form-group">
                    <label class="form-label">Verification Code</label>
                    <div class="verification-code">
                        <input type="text" class="code-input" maxlength="1" data-index="0">
                        <input type="text" class="code-input" maxlength="1" data-index="1">
                        <input type="text" class="code-input" maxlength="1" data-index="2">
                        <input type="text" class="code-input" maxlength="1" data-index="3">
                        <input type="text" class="code-input" maxlength="1" data-index="4">
                        <input type="text" class="code-input" maxlength="1" data-index="5">
                    </div>
                    <input type="hidden" id="fullCode" name="fullCode">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" id="backToEmail">Back</button>
                    <button type="submit" class="btn btn-primary">Verify</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for adding a review -->
<div id="addReviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Review for <span id="reviewTAName"></span></h2>
            <button class="close-btn">&times;</button>
        </div>
        <form id="addReviewForm">
            <div class="form-group">
                <label class="form-label">Course</label>
                <select id="reviewCourse" class="form-input" required>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Overall Rating</label>
                <div class="star-rating">
                    <input type="radio" id="star5" name="overallRating" value="5" required>
                    <label for="star5">‚òÖ</label>
                    <input type="radio" id="star4" name="overallRating" value="4">
                    <label for="star4">‚òÖ</label>
                    <input type="radio" id="star3" name="overallRating" value="3">
                    <label for="star3">‚òÖ</label>
                    <input type="radio" id="star2" name="overallRating" value="2">
                    <label for="star2">‚òÖ</label>
                    <input type="radio" id="star1" name="overallRating" value="1">
                    <label for="star1">‚òÖ</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Helpfulness in Office Hours</label>
                <div class="star-rating">
                    <input type="radio" id="office5" name="officeHours" value="5" required>
                    <label for="office5">‚òÖ</label>
                    <input type="radio" id="office4" name="officeHours" value="4">
                    <label for="office4">‚òÖ</label>
                    <input type="radio" id="office3" name="officeHours" value="3">
                    <label for="office3">‚òÖ</label>
                    <input type="radio" id="office2" name="officeHours" value="2">
                    <label for="office2">‚òÖ</label>
                    <input type="radio" id="office1" name="officeHours" value="1">
                    <label for="office1">‚òÖ</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Responsiveness on Piazza</label>
                <div class="star-rating">
                    <input type="radio" id="piazza5" name="piazza" value="5" required>
                    <label for="piazza5">‚òÖ</label>
                    <input type="radio" id="piazza4" name="piazza" value="4">
                    <label for="piazza4">‚òÖ</label>
                    <input type="radio" id="piazza3" name="piazza" value="3">
                    <label for="piazza3">‚òÖ</label>
                    <input type="radio" id="piazza2" name="piazza" value="2">
                    <label for="piazza2">‚òÖ</label>
                    <input type="radio" id="piazza1" name="piazza" value="1">
                    <label for="piazza1">‚òÖ</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Grading Style</label>
                <div class="star-rating">
                    <input type="radio" id="grading5" name="grading" value="5" required>
                    <label for="grading5">‚òÖ</label>
                    <input type="radio" id="grading4" name="grading" value="4">
                    <label for="grading4">‚òÖ</label>
                    <input type="radio" id="grading3" name="grading" value="3">
                    <label for="grading3">‚òÖ</label>
                    <input type="radio" id="grading2" name="grading" value="2">
                    <label for="grading2">‚òÖ</label>
                    <input type="radio" id="grading1" name="grading" value="1">
                    <label for="grading1">‚òÖ</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="reviewComment">Additional Comments</label>
                <textarea id="reviewComment" class="form-input" rows="4" placeholder="Share your experience with this TA..."></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn" id="cancelReview">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Review</button>
            </div>
        </form>
    </div>
</div>

<footer class="footer">
    <p>University at Buffalo ‚Ä¢ Computer Science & Engineering Department</p>
    <p>This platform is designed to help students provide constructive feedback on teaching assistants.</p>
</footer>

<script>
    // Client-side TA store (populated from server)
    let TAS = [];

    // Current user state
    let currentUser = null;
    let currentTAForReview = null;
    let verificationCode = null;
    let verificationTimer = null;
    let verificationEmail = null;

    // DOM Elements
    const taListEl = document.getElementById("taList");
    const searchInput = document.getElementById("searchInput");
    const courseSelect = document.getElementById("courseSelect");
    const emptyState = document.getElementById("emptyState");
    const addTAButton = document.getElementById("addTAButton");
    const addTAModal = document.getElementById("addTAModal");
    const addTAForm = document.getElementById("addTAForm");
    const cancelAddTA = document.getElementById("cancelAddTA");
    const closeModalBtns = document.querySelectorAll(".close-btn");
    const authButton = document.getElementById("authButton");
    const authModal = document.getElementById("authModal");
    const authForm = document.getElementById("authForm");
    const cancelAuth = document.getElementById("cancelAuth");
    const addReviewModal = document.getElementById("addReviewModal");
    const addReviewForm = document.getElementById("addReviewForm");
    const cancelReview = document.getElementById("cancelReview");
    const reviewTAName = document.getElementById("reviewTAName");
    const reviewCourse = document.getElementById("reviewCourse");
    const tagOptions = document.querySelectorAll(".tag-option");
    const emailStep = document.getElementById("emailStep");
    const codeStep = document.getElementById("codeStep");
    const codeForm = document.getElementById("codeForm");
    const backToEmail = document.getElementById("backToEmail");
    const emailDisplay = document.getElementById("emailDisplay");
    const resendCode = document.getElementById("resendCode");
    const timerDisplay = document.getElementById("timer");
    const codeInputs = document.querySelectorAll(".code-input");
    const fullCodeInput = document.getElementById("fullCode");

    // Check if we're on a TA detail page
    const urlParams = new URLSearchParams(window.location.search);
    const taId = urlParams.get('id');

    // Initialize the application
    initApp();

    function initApp() {
        // Check for stored user
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = storedUser;
            updateAuthUI();
        }

        if (taId) {
            // We're on a detail page, fetch TA detail from server
            fetch(`/api/tas/${encodeURIComponent(taId)}`)
                .then(r => {
                    if (!r.ok) throw new Error('TA not found');
                    return r.json();
                })
                .then(serverTA => {
                    const ta = transformServerTA(serverTA);
                    showTADetail(ta);
                })
                .catch(err => {
                    console.error(err);
                    document.querySelector('.container').innerHTML = `<div class="ta-detail"><h2>TA Not Found</h2><p>The requested teaching assistant could not be found.</p><button class="btn btn-primary" onclick="window.location.href = '?'">Back to TA List</button></div>`;
                });
        } else {
            // We're on the main page, fetch TA list
            initializeMainPage();
        }

        // Set up event listeners
        setupEventListeners();
    }

    function transformServerTA(serverTA) {
        // Server TA may have _id or id and averageRating or avgRating
        const id = serverTA.id || serverTA._id;
        const avgRating = serverTA.averageRating || serverTA.avgRating || 0;
        const reviews = (serverTA.reviews || []).map(r => ({
            // support both shapes: {rating, comment, timestamp} and older client shape
            overallRating: r.overallRating || r.rating || 0,
            officeHours: r.officeHours || r.officeHours || null,
            piazza: r.piazza || null,
            grading: r.grading || null,
            tags: r.tags || [],
            comment: r.comment || r.text || '',
            date: r.timestamp ? (new Date(r.timestamp)).toISOString().split('T')[0] : (r.date || '')
        }));

        return {
            id: id,
            name: serverTA.name,
            courses: serverTA.courses || [],
            avgRating: avgRating,
            reviewCount: reviews.length,
            aiSummary: serverTA.aiSummary || serverTA.summary || "No summary available.",
            reviews: reviews
        };
    }

    function setupEventListeners() {
        // Main page event listeners
        if (!taId) {
            searchInput.addEventListener("input", applyFilters);
            courseSelect.addEventListener("change", applyFilters);
            addTAButton.addEventListener("click", () => addTAModal.style.display = "flex");
            cancelAddTA.addEventListener("click", () => addTAModal.style.display = "none");
            addTAForm.addEventListener("submit", handleAddTA);
        }

        // Authentication
        authButton.addEventListener("click", () => {
            showEmailStep();
            authModal.style.display = "flex";
        });
        cancelAuth.addEventListener("click", () => authModal.style.display = "none");
        authForm.addEventListener("submit", handleEmailSubmit);
        codeForm.addEventListener("submit", handleCodeSubmit);
        backToEmail.addEventListener("click", showEmailStep);
        resendCode.addEventListener("click", handleResendCode);

        // Code input handling
        codeInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;

                // Only allow numbers
                if (!/^\d*$/.test(value)) {
                    e.target.value = '';
                    return;
                }

                // Move to next input if current one is filled
                if (value && index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }

                updateFullCode();
            });

            input.addEventListener('keydown', (e) => {
                // Handle backspace
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });

            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text').trim();

                if (/^\d{6}$/.test(pasteData)) {
                    // Fill all inputs with the pasted code
                    for (let i = 0; i < 6; i++) {
                        codeInputs[i].value = pasteData[i];
                    }
                    updateFullCode();
                    codeInputs[5].focus();
                }
            });
        });

        // Review modal
        cancelReview.addEventListener("click", () => addReviewModal.style.display = "none");
        addReviewForm.addEventListener("submit", handleAddReview);

        // Close modals when clicking outside
        window.addEventListener("click", (e) => {
            if (e.target === addTAModal) addTAModal.style.display = "none";
            if (e.target === authModal) authModal.style.display = "none";
            if (e.target === addReviewModal) addReviewModal.style.display = "none";
        });

        // Close modals with close buttons
        closeModalBtns.forEach(btn => {
            btn.addEventListener("click", function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // Tag selection
        tagOptions.forEach(tag => {
            tag.addEventListener("click", function() {
                this.classList.toggle("selected");
                updateSelectedTags();
            });
        });
    }

    function updateFullCode() {
        const code = Array.from(codeInputs).map(input => input.value).join('');
        fullCodeInput.value = code;
    }

    function showEmailStep() {
        emailStep.style.display = 'block';
        codeStep.style.display = 'none';
        authForm.reset();

        // Clear any existing timer
        if (verificationTimer) {
            clearInterval(verificationTimer);
            verificationTimer = null;
        }
    }

    function showCodeStep(email) {
        emailStep.style.display = 'none';
        codeStep.style.display = 'block';
        emailDisplay.textContent = email;
        verificationEmail = email;

        // Clear code inputs
        codeInputs.forEach(input => input.value = '');
        updateFullCode();
        codeInputs[0].focus();

        // Generate and "send" verification code
        generateVerificationCode();

        // Start countdown timer
        startVerificationTimer();
    }

    function generateVerificationCode() {
        // Generate a random 6-digit code
        verificationCode = Math.floor(100000 + Math.random() * 900000).toString();

        // In a real application, you would send this code to the user's email
        // For this demo, we'll just log it to the console and show an alert
        console.log(`Verification code for ${verificationEmail}: ${verificationCode}`);
        alert(`DEMO: Verification code sent to ${verificationEmail}: ${verificationCode}\n\nIn a real application, this would be sent via email.`);
    }

    function startVerificationTimer() {
        let timeLeft = 600; // 10 minutes in seconds

        // Update timer immediately
        updateTimerDisplay(timeLeft);

        // Update timer every second
        verificationTimer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay(timeLeft);

            if (timeLeft <= 0) {
                clearInterval(verificationTimer);
                alert("Verification code has expired. Please request a new one.");
                showEmailStep();
            }
        }, 1000);
    }

    function updateTimerDisplay(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        timerDisplay.textContent = `Code expires in: ${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
    }

    function handleEmailSubmit(e) {
        e.preventDefault();
        const email = document.getElementById("emailInput").value;

        if (email.endsWith("@buffalo.edu")) {
            showCodeStep(email);
        } else {
            alert("Please use a valid UB email address (ending with @buffalo.edu)");
        }
    }

    function handleCodeSubmit(e) {
        e.preventDefault();
        const enteredCode = fullCodeInput.value;

        if (enteredCode === verificationCode) {
            currentUser = verificationEmail;
            localStorage.setItem('currentUser', verificationEmail);
            updateAuthUI();
            authModal.style.display = "none";

            // Clear verification data
            verificationCode = null;
            verificationEmail = null;
            if (verificationTimer) {
                clearInterval(verificationTimer);
                verificationTimer = null;
            }

            alert(`Successfully verified and signed in as ${currentUser}`);
        } else {
            alert("Invalid verification code. Please try again.");
            // Clear code inputs
            codeInputs.forEach(input => input.value = '');
            updateFullCode();
            codeInputs[0].focus();
        }
    }

    function handleResendCode() {
        if (verificationEmail) {
            generateVerificationCode();

            // Reset and restart timer
            if (verificationTimer) {
                clearInterval(verificationTimer);
            }
            startVerificationTimer();

            alert("New verification code sent!");
        }
    }

    function initializeMainPage() {
        // Fetch TA list from server
        fetch('/api/tas')
            .then(r => r.json())
            .then(data => {
                TAS = (data || []).map(transformServerTA);

                // Build course dropdown from fetched data
                const courseSet = new Set();
                TAS.forEach(ta => ta.courses.forEach(c => courseSet.add(c)));

                // Sort courses numerically when possible, otherwise lexicographically
                const sortedCourses = Array.from(courseSet).sort((a, b) => {
                    const numA = (a.match(/\d+/) || [0])[0];
                    const numB = (b.match(/\d+/) || [0])[0];
                    if (numA && numB) return parseInt(numA) - parseInt(numB);
                    return a.localeCompare(b);
                });

                sortedCourses.forEach(course => {
                    const opt = document.createElement("option");
                    opt.value = course;
                    opt.textContent = course;
                    courseSelect.appendChild(opt);
                });

                // Initial render
                renderList(TAS);
            })
            .catch(err => {
                console.error('Failed to load TAs from API', err);
                // fallback: show empty state
                renderList([]);
            });
    }

    function updateAuthUI() {
        if (currentUser) {
            authButton.innerHTML = `<span class="verified-badge"></span> Signed in as ${currentUser}`;
            authButton.classList.add("btn-disabled");
            authButton.disabled = true;
        } else {
            authButton.textContent = "Sign in with UB Email";
            authButton.classList.remove("btn-disabled");
            authButton.disabled = false;
        }
    }

    function handleAddTA(e) {
        e.preventDefault();

        if (!currentUser) {
            alert("Please sign in with your UB email to add a TA");
            authModal.style.display = "flex";
            return;
        }

        const name = document.getElementById("taName").value;
        const courses = document.getElementById("taCourses").value
            .split(',')
            .map(course => course.trim())
            .filter(course => course !== '');

        if (name && courses.length > 0) {
            // POST to server
            fetch('/api/tas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, courses: courses })
            })
            .then(r => {
                if (!r.ok) throw new Error('Failed to create TA');
                return r.json();
            })
            .then(created => {
                const ta = transformServerTA(created);
                TAS.push(ta);
                addTAModal.style.display = "none";
                addTAForm.reset();

                // Update course dropdown with any new courses
                ta.courses.forEach(course => {
                    if (!Array.from(courseSelect.options).some(opt => opt.value === course)) {
                        const opt = document.createElement("option");
                        opt.value = course;
                        opt.textContent = course;
                        courseSelect.appendChild(opt);
                    }
                });

                renderList(TAS);
                alert(`Successfully added ${name} to the TA list!`);
            })
            .catch(err => {
                console.error('Error creating TA', err);
                alert('Failed to create TA. Try again later.');
            });
        }
    }

    function openReviewModal(ta) {
        if (!currentUser) {
            alert("Please sign in with your UB email to submit a review");
            authModal.style.display = "flex";
            return;
        }

        // Check if user has already reviewed this TA
        const hasReviewed = ta.reviews.some(review => review.userId === currentUser || review.user === currentUser);
        if (hasReviewed) {
            alert("You have already submitted a review for this TA. Each user can only review a TA once.");
            return;
        }

        currentTAForReview = ta;
        reviewTAName.textContent = ta.name;

        // Populate course dropdown
        reviewCourse.innerHTML = '';
        ta.courses.forEach(course => {
            const option = document.createElement("option");
            option.value = course;
            option.textContent = course;
            reviewCourse.appendChild(option);
        });

        // Reset form
        addReviewForm.reset();
        tagOptions.forEach(tag => tag.classList.remove("selected"));
        updateSelectedTags();

        addReviewModal.style.display = "flex";
    }

    function updateSelectedTags() {
        const selected = Array.from(document.querySelectorAll(".tag-option.selected"))
            .map(tag => tag.getAttribute("data-tag"));
        document.getElementById("selectedTags").value = JSON.stringify(selected);
    }

    function handleAddReview(e) {
        e.preventDefault();

        if (!currentUser || !currentTAForReview) return;

        const formData = new FormData(addReviewForm);
        const overallRating = parseInt(formData.get("overallRating"));
        const comment = formData.get("reviewComment");

        // Post a minimal review object to the server (backend expects rating + comment)
        fetch(`/api/tas/${encodeURIComponent(currentTAForReview.id)}/reviews`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rating: overallRating, comment: comment })
        })
        .then(r => {
            if (!r.ok) throw new Error('Failed to submit review');
            return r.json();
        })
        .then(updatedTA => {
            // Update local copy
            const updated = transformServerTA(updatedTA);
            const idx = TAS.findIndex(t => t.id === updated.id);
            if (idx !== -1) TAS[idx] = updated;
            if (taId) {
                // We're on detail page ‚Äî reload it
                showTADetail(updated);
            } else {
                renderList(TAS);
            }

            addReviewModal.style.display = 'none';
            addReviewForm.reset();
            alert('Thank you for your review!');
        })
        .catch(err => {
            console.error('Error submitting review', err);
            alert('Failed to submit review. Try again later.');
        });
    }

    function updateTAStats(ta) {
        if (!ta.reviews || ta.reviews.length === 0) {
            ta.avgRating = 0;
            ta.reviewCount = 0;
            return;
        }

        // Calculate average overall rating (reviews may use overallRating or rating)
        const totalRating = ta.reviews.reduce((sum, review) => sum + (review.overallRating || review.rating || 0), 0);
        ta.avgRating = totalRating / ta.reviews.length;
        ta.reviewCount = ta.reviews.length;

        // Update AI summary based on reviews
        updateAISummary(ta);
    }

    function updateAISummary(ta) {
        if (!ta.reviews || ta.reviews.length === 0) {
            ta.aiSummary = "No reviews yet. Be the first to review this TA!";
            return;
        }

        // Basic summary logic (same as before)
        const officeHoursAvg = ta.reviews.reduce((sum, review) => sum + (review.officeHours || 0), 0) / ta.reviews.length;
        const piazzaAvg = ta.reviews.reduce((sum, review) => sum + (review.piazza || 0), 0) / ta.reviews.length;
        const gradingAvg = ta.reviews.reduce((sum, review) => sum + (review.grading || 0), 0) / ta.reviews.length;

        const tagCounts = {};
        ta.reviews.forEach(review => {
            (review.tags || []).forEach(tag => {
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
        });

        const topTags = Object.entries(tagCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(entry => entry[0]);

        let summary = `${ta.name} is `;

        if (ta.avgRating >= 4.5) {
            summary += "highly regarded by students. ";
        } else if (ta.avgRating >= 4.0) {
            summary += "well-regarded by students. ";
        } else if (ta.avgRating >= 3.0) {
            summary += "generally viewed positively by students. ";
        } else {
            summary += "has mixed reviews from students. ";
        }

        if (officeHoursAvg >= 4.5) {
            summary += "Students consistently praise their office hours as extremely helpful. ";
        } else if (officeHoursAvg >= 4.0) {
            summary += "Students find their office hours generally helpful. ";
        }

        if (piazzaAvg >= 4.5) {
            summary += "They are very responsive on Piazza and provide helpful answers. ";
        }

        if (gradingAvg >= 4.5) {
            summary += "Their grading is considered fair and timely. ";
        } else if (gradingAvg <= 2.5) {
            summary += "Some students have expressed concerns about their grading practices. ";
        }

        if (topTags.length > 0) {
            summary += `Common descriptors include: ${topTags.join(", ")}.`;
        }

        ta.aiSummary = summary;
    }

    // Helper function to generate star rating visualization
    function generateStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        let starsHTML = '';

        for (let i = 0; i < 5; i++) {
            if (i < fullStars) {
                starsHTML += '‚òÖ';
            } else if (i === fullStars && hasHalfStar) {
                starsHTML += '¬Ω';
            } else {
                starsHTML += '‚òÜ';
            }
        }

        return `<span class="stars">${starsHTML}</span>`;
    }

    function renderList(data) {
        taListEl.innerHTML = "";
        if (data.length === 0) {
            emptyState.style.display = "block";
            return;
        }
        emptyState.style.display = "none";

        data.forEach(ta => {
            const card = document.createElement("div");
            card.className = "ta-card";

            // Calculate rating bar width
            const ratingPercent = (ta.avgRating / 5) * 100;

            card.innerHTML = `
                    <div>
                        <div class="ta-name">${ta.name}</div>
                        <div class="ta-courses">
                            ${ta.courses.map(course => `<span class="course-tag">${course}</span>`).join('')}
                        </div>
                    </div>
                    <div class="ta-rating">
                        <div>
                            <div class="rating-label">Avg Rating</div>
                            <div class="rating-value">
                                ${ta.avgRating.toFixed(1)}
                                ${generateStars(ta.avgRating)}
                            </div>
                            <div class="rating-label">${ta.reviewCount} review${ta.reviewCount !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="rating-bar">
                            <div class="rating-fill" style="width: ${ratingPercent}%"></div>
                        </div>
                    </div>
                `;

            card.addEventListener("click", () => {
                window.location.href = `?id=${ta.id}`;
            });

            taListEl.appendChild(card);
        });
    }

    function applyFilters() {
        const text = searchInput.value.toLowerCase();
        const selectedCourse = courseSelect.value;

        const filtered = TAS.filter(ta => {
            const matchesSearch =
                ta.name.toLowerCase().includes(text) ||
                ta.courses.some(c => c.toLowerCase().includes(text));

            const matchesCourse =
                selectedCourse === "all" || ta.courses.includes(selectedCourse);

            return matchesSearch && matchesCourse;
        });

        renderList(filtered);
    }

    function showTADetail(idOrTA) {
        // If called with an id string, fetch from server
        if (typeof idOrTA === 'string' || typeof idOrTA === 'number') {
            const id = idOrTA;
            fetch(`/api/tas/${encodeURIComponent(id)}`)
                .then(r => {
                    if (!r.ok) throw new Error('TA not found');
                    return r.json();
                })
                .then(serverTA => showTADetail(transformServerTA(serverTA)))
                .catch(err => {
                    console.error(err);
                    document.querySelector('.container').innerHTML = `<div class="ta-detail"><h2>TA Not Found</h2><p>The requested teaching assistant could not be found.</p><button class="btn btn-primary" onclick="window.location.href = '?'">Back to TA List</button></div>`;
                });
            return;
        }

        // Now idOrTA is a TA object transformed for client use
        const ta = idOrTA;
        // Update the main container to show TA details
        const container = document.querySelector('.container');

        // Calculate averages for rating breakdown
        const officeHoursAvg = ta.reviews.length > 0 ?
            (ta.reviews.reduce((sum, review) => sum + (review.officeHours || 0), 0) / ta.reviews.length).toFixed(1) : "N/A";
        const piazzaAvg = ta.reviews.length > 0 ?
            (ta.reviews.reduce((sum, review) => sum + (review.piazza || 0), 0) / ta.reviews.length).toFixed(1) : "N/A";
        const gradingAvg = ta.reviews.length > 0 ?
            (ta.reviews.reduce((sum, review) => sum + (review.grading || 0), 0) / ta.reviews.length).toFixed(1) : "N/A";

        // Get unique courses from reviews for filtering
        const reviewCourses = [...new Set(ta.reviews.map(review => review.course || ""))].filter(Boolean);

        // Calculate rating bar width
        const ratingPercent = (ta.avgRating / 5) * 100;

        container.innerHTML = `
                <div class="action-bar">
                    <button class="btn" onclick="window.location.href = '?'">‚Üê Back to TA List</button>
                    <button class="btn btn-primary" id="addReviewButton">Add Review</button>
                </div>

                <div class="ta-detail">
                    <div class="ta-header">
                        <div class="ta-info">
                            <h2>${ta.name}</h2>
                            <div class="ta-courses">
                                ${ta.courses.map(course => `<span class="course-tag">${course}</span>`).join('')}
                            </div>
                        </div>
                        <div class="ta-rating">
                            <div class="rating-label">Overall Rating</div>
                            <div class="rating-value">
                                ${ta.avgRating.toFixed(1)}
                                ${generateStars(ta.avgRating)}
                            </div>
                            <div class="rating-label">${ta.reviewCount} review${ta.reviewCount !== 1 ? 's' : ''}</div>
                            <div class="rating-bar">
                                <div class="rating-fill" style="width: ${ratingPercent}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="rating-breakdown">
                        <div class="breakdown-category">
                            <h4>Office Hours Helpfulness</h4>
                            <div class="breakdown-value">${officeHoursAvg}</div>
                            ${officeHoursAvg !== "N/A" ? generateStars(parseFloat(officeHoursAvg)) : ""}
                        </div>
                        <div class="breakdown-category">
                            <h4>Piazza Responsiveness</h4>
                            <div class="breakdown-value">${piazzaAvg}</div>
                            ${piazzaAvg !== "N/A" ? generateStars(parseFloat(piazzaAvg)) : ""}
                        </div>
                        <div class="breakdown-category">
                            <h4>Grading</h4>
                            <div class="breakdown-value">${gradingAvg}</div>
                            ${gradingAvg !== "N/A" ? generateStars(parseFloat(gradingAvg)) : ""}
                        </div>
                    </div>

                    <div class="ai-summary">
                        <h3>AI Summary</h3>
                        <p>${ta.aiSummary}</p>
                    </div>

                    <div class="reviews-section">
                        <div class="filter-controls">
                            <h3>Student Reviews</h3>
                            <select id="reviewFilter" class="select">
                                <option value="all">All Courses</option>
                                ${reviewCourses.map(course => `<option value="${course}">${course}</option>`).join('')}
                            </select>
                        </div>
                        ${ta.reviews.length > 0 ?
            ta.reviews.map(review => `
                                <div class="review-card" data-course="${review.course || ''}">
                                    ${review.course ? `<div class="review-course">${review.course}</div>` : ''}
                                    <div class="review-header">
                                        <div class="anonymous-user">UB Student</div>
                                        <div class="review-date">${review.date || ''}</div>
                                    </div>
                                    <div class="review-details">
                                        <div class="rating-category">
                                            <span class="rating-category-name">Overall</span>
                                            <span class="rating-category-value">${(review.overallRating || review.rating || 0)}/5 ${generateStars((review.overallRating || review.rating || 0))}</span>
                                        </div>
                                        <div class="rating-category">
                                            <span class="rating-category-name">Office Hours</span>
                                            <span class="rating-category-value">${review.officeHours || 'N/A'}/5</span>
                                        </div>
                                        <div class="rating-category">
                                            <span class="rating-category-name">Piazza</span>
                                            <span class="rating-category-value">${review.piazza || 'N/A'}/5</span>
                                        </div>
                                        <div class="rating-category">
                                            <span class="rating-category-name">Grading</span>
                                            <span class="rating-category-value">${review.grading || 'N/A'}/5</span>
                                        </div>
                                    </div>
                                    ${review.tags && review.tags.length > 0 ? `
                                        <div class="review-tags">
                                            ${review.tags.map(tag => `<span class="review-tag">${tag}</span>`).join('')}
                                        </div>
                                    ` : ''}
                                    ${review.comment ? `<div class="review-comment">${review.comment}</div>` : ''}
                                </div>
                            `).join('') :
            '<p>No reviews yet. Be the first to review this TA!</p>'
        }
                    </div>
                </div>
            `;

        // Add event listener for the Add Review button
        document.getElementById("addReviewButton").addEventListener("click", () => openReviewModal(ta));

        // Add event listener for review filtering
        document.getElementById("reviewFilter").addEventListener("change", function() {
            const selectedCourse = this.value;
            const reviewCards = document.querySelectorAll('.review-card');

            reviewCards.forEach(card => {
                if (selectedCourse === "all" || card.getAttribute("data-course") === selectedCourse) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            });
        });
    }
</script>
</body>
</html>

